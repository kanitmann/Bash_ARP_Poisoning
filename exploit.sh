#! /bin/bash
echo ""
echo "VIT University"
echo "Information Security Management"
echo "Submitted to Prof. Ruby D"
sleep 4
argmt=$1
md=$2
itfe=$3

gateway=`ip route | grep default`
gateway=${gateway##*via}
gateway=${gateway%dev*}

if [ -z " $itfe " ];then
channel=`iwlist $itfe channel`
channel=${channel%)*}
channel=${channel##*l}
fi
if [ " $argmt " = ' -r ' ] || [ " $argmt " = ' --reset ' ]; then
itfemon=$itfe'mon'

service network-manager restart ;
echo "Network reset is Succesfull !"
sleep 2
#=================================================================

elif
     [ "$argmt" = '-d' ] || [ "$argmt" = '--defence' ]; then

     gtping=`ping $gateway -c 1`
     gtping=${gtping%$gateway*}
     gtping=${gtping%$gateway*}
     gtping=${gtping%$gateway*}
     gtping=${gtping%$gateway*}
     if [ " $gtping " = " PING " ] ; then
      MYVAR='sudo arp $gateway -i $itfe '
      add=${MYVAR%C*} # retain the part after the C
      add=${add##*r} # retain the part before the ether
      if [ /usr/shARP/ = false ] && [ /usr/shARP/ != true ]; then
      sudo mkdir /usr/shARP
      fi
    mkdir -p /usr/shARP/
    touch /usr/shARP/gateway.txt
      echo $(date +"%D") ": DEFENSIVE md : The original address of the gateway is " $add >> /usr/shARP/gateway.txt
    arp $gateway -i $itfe
    arpout=`arp $gateway -i $itfe`
echo "..........."

arpd=$add
carpd=$arpd
carpd=${carpd//[ ]/}
vendor=${carpd//[:]/}
vendor=${vendor:0:6}
while read line
do macid=${line:0:6}
vendor="${vendor^^}"
if [ "$macid" == "$vendor" ]
then
  echo "Your current gateway is " $add " and your MACVendor is " ${line:(+6)}

fi

done < mac-vendors.txt
echo "...................................................................................................................................
..........."
   
    if [ "$md" = '-a' ] || [ "$md"  = "--active" ];then
       
                  while true
do

                        output=`sudo arp $gateway -i $itfe`
carpd=${output%C*} # delete the part after the C
carpd=${carpd##*r} # delete the part before the ether
arpd=${arpd//[ ]/}
carpd=${carpd//[ ]/}

                        if [ " $arpd " != " $carpd " ]; then
echo "Gateway changed from"$arpd"to"$carpd " at time " $(date +"%T")

echo $carpd "is spoofing detected"
echo "network connection going down"
ifconfig $itfe down
     vendor=${carpd//[:]/}
     vendor=${vendor:0:6}
     while read line
do macid=${line:0:6}
  vendor="${vendor^^}"
   if [ " $macid " = " $vendor " ]
   then
   echo "MAC Vendor of the attacker is " ${line:(+6)}
   macvendor=${line:(+6)}
   fi
      done < mac-vendors.txt
echo "Gateway changed from " $arpd " to " $carpd " at time "$(date +"%T") " on " $(date +"%D") " The attacker's MAC vendor is " $macvendor >> /usr/shARP/log.txt
   echo 'This network is being spoofed by '$carpd'. Connection is going down for your own safety from spoofing attack. Be aware as this network is going to be down soon.'
    sleep 6
    exit
      fi ;
done;

      elif [ "$md" == '-p' ] || [ "$md" == "--passive" ];then

   mymac=`ifconfig $itfe`
   mymac=${mymac%tx*}
   mymac=${mymac##*ether}

   python mac_decoder.py $mymac $arpd $itfe $argmt
      fi
      else echo "Gateway is not found"
      fi

elif [ "$argmt" == '-h' ]||[ "$argmt" == '--help' ]; then
 echo " "
fi